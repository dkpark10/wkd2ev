{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/qa 과정에서 깃헙페이지에 멀티 페이지 배포 워크플로우 작성해보기/","result":{"data":{"site":{"siteMetadata":{"title":"wkd2ev"}},"markdownRemark":{"id":"ae22ba41-45bb-5046-b973-f0cd5baaf80c","excerpt":"회사마다 다르겠지만 사내에서 신규 기능이나 버그를 수정하고 다시 피드백을 받는 과정은 간략하게 다음과 같다.  ci/cd 에서 빌드 후 eks에 태그를 푸시하는 과정이 반드시 소요된다. 1px 수정이나 개발자가 놓친것이 있어 빠르게 확인해야 할 때 또는 ssr…","html":"<p>회사마다 다르겠지만 사내에서 신규 기능이나 버그를 수정하고 다시 피드백을 받는 과정은 간략하게 다음과 같다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/wkd2ev/static/4870b1cbe8b45b71cdf5f44c1a3f98a9/5bd27/deploy-before.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.417721518987342%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmElEQVR42m2QCwrEMAhEc/9DtjdImg9t/i5PEHbLCoPJOI4mrvcuYwzFnFPWWvI8j9Ra5b5vaa3J3vtHQw86gjMayw5RCEGFENd1ifdezvOU4ziklCIxRh1gdQbAMxhgllJSD2cXTHPOKqDRsr2AMxtj9M3TY+ZwjrWZyBMQ2CbvbyADOGsGVscDqOE7rIgQc4YYuJvBv/gAyziHpSRXDVoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"배포과정\"\n        title=\"\"\n        src=\"/wkd2ev/static/4870b1cbe8b45b71cdf5f44c1a3f98a9/f058b/deploy-before.png\"\n        srcset=\"/wkd2ev/static/4870b1cbe8b45b71cdf5f44c1a3f98a9/c26ae/deploy-before.png 158w,\n/wkd2ev/static/4870b1cbe8b45b71cdf5f44c1a3f98a9/6bdcf/deploy-before.png 315w,\n/wkd2ev/static/4870b1cbe8b45b71cdf5f44c1a3f98a9/f058b/deploy-before.png 630w,\n/wkd2ev/static/4870b1cbe8b45b71cdf5f44c1a3f98a9/40601/deploy-before.png 945w,\n/wkd2ev/static/4870b1cbe8b45b71cdf5f44c1a3f98a9/78612/deploy-before.png 1260w,\n/wkd2ev/static/4870b1cbe8b45b71cdf5f44c1a3f98a9/5bd27/deploy-before.png 1432w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ci/cd 에서 빌드 후 eks에 태그를 푸시하는 과정이 반드시 소요된다.</p>\n<p>1px 수정이나 개발자가 놓친것이 있어 빠르게 확인해야 할 때 또는 ssr이나 서버의 실행이 필요없는 정적 기능일 때\neks 푸시 과정을 생략하여 깃헙페이지로 정적 배포 빠르게 피드백을 받아 아래와 같이 효율성을 개선하고 싶었다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/wkd2ev/static/2ffc595f4c3c23527d5fd312134231af/6b95e/deploy-after.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.62025316455696%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAm0lEQVR42k2Qyw6EIAxF+f8fNLN1MRs3CvgAlTs9TZpMk6alj9Mb0vu+uu9bz/N4HJL6vqvlrFaKRyxmwjF2W2vqvbuPMZTiUWv1QjFItvz7+WieJhXL6bF4HIfH67rcdzsMlAiDXuIyybquyqbmZNgAeZ5Vl8WV4QAABhSVgBBAL2oJ6SjjEoXO8rapM2Tg0/KYCSjL/19AD8d+g5E4Wh6Oy38AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"배포과정\"\n        title=\"\"\n        src=\"/wkd2ev/static/2ffc595f4c3c23527d5fd312134231af/f058b/deploy-after.png\"\n        srcset=\"/wkd2ev/static/2ffc595f4c3c23527d5fd312134231af/c26ae/deploy-after.png 158w,\n/wkd2ev/static/2ffc595f4c3c23527d5fd312134231af/6bdcf/deploy-after.png 315w,\n/wkd2ev/static/2ffc595f4c3c23527d5fd312134231af/f058b/deploy-after.png 630w,\n/wkd2ev/static/2ffc595f4c3c23527d5fd312134231af/40601/deploy-after.png 945w,\n/wkd2ev/static/2ffc595f4c3c23527d5fd312134231af/78612/deploy-after.png 1260w,\n/wkd2ev/static/2ffc595f4c3c23527d5fd312134231af/6b95e/deploy-after.png 1458w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>실제로 사내에서 배포되고 있는 브랜치의 폴더 구조이다. pr 별로 구별하여 정적페이지를 확인하도록 했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/wkd2ev/static/15fc359cba78228f742f2d02ff873951/11a8f/real.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.810126582278485%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA6UlEQVR42n2RiY7CMAxE+//fyQr1yt3mgsxOXCpRIbBk5bKfx87w5xrGeUWtBd8s5Yx5WaGNhdIGq9Lcm8u+v8WYMMzhCW0dHrWitfbh3XIpMIzxPsA5D8fVh01Wy7MPxzmz8DCFBmUIfNSvCkupAnQCPKAC916AZ4GcC4aRChXl/lTIQKWtJFuCT4ghXAq9FKZEhTddcB8XXuycVUVM5eL9zvmdc1ZYVoNp0ZhXjUl53FWEZXfveVTYsCgjbXXrot79VNiHbl+KRGWIUJ6gbb/kCbBX/PXLR8tGQMYSTNdux2TZwbZdYv8BWVUgRscHsfMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"real\"\n        title=\"\"\n        src=\"/wkd2ev/static/15fc359cba78228f742f2d02ff873951/f058b/real.png\"\n        srcset=\"/wkd2ev/static/15fc359cba78228f742f2d02ff873951/c26ae/real.png 158w,\n/wkd2ev/static/15fc359cba78228f742f2d02ff873951/6bdcf/real.png 315w,\n/wkd2ev/static/15fc359cba78228f742f2d02ff873951/f058b/real.png 630w,\n/wkd2ev/static/15fc359cba78228f742f2d02ff873951/40601/real.png 945w,\n/wkd2ev/static/15fc359cba78228f742f2d02ff873951/78612/real.png 1260w,\n/wkd2ev/static/15fc359cba78228f742f2d02ff873951/11a8f/real.png 1272w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>하나의 서비스에 여러 개발자가 따로 작업하고 있을 수 있기에 Pr 단위로 멀티 페이지를 배포 스크립트를 작성했다.</p>\n<p>예제는 spa 라이브러리 react를 이용했다.</p>\n<h2>링크</h2>\n<p><a href=\"https://github.com/dkpark10/action-test/tree/master/apps/react\">https://github.com/dkpark10/action-test/tree/master/apps/react</a></p>\n<p><a href=\"https://github.com/dkpark10/action-test/blob/master/.github/workflows/page-deploy.yaml\">https://github.com/dkpark10/action-test/blob/master/.github/workflows/page-deploy.yaml</a></p>\n<p><a href=\"https://dkpark10.github.io/action-test/pr-3/\">https://dkpark10.github.io/action-test/pr-3/ 에제 페이지</a></p>\n<h2>배포 스크립트</h2>\n<deckgo-highlight-code language=\"shell\"  >\n          <code slot=\"code\">name: &#39;deploy-github-page&#39;\n\non:\n  pull_request:\n    types:\n      - opened\n      - reopened\n      - synchronize\n\n  workflow_dispatch:\n\njobs:\n  deploy-page:\n    concurrency: ci-${{ github.ref }} #https://github.com/JamesIves/github-pages-deploy-action\n\n    runs-on: ubuntu-latest\n\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v4\n\n      - uses: pnpm/action-setup@v4\n        with:\n          version: 8\n\n      - uses: actions/setup-node@v3\n        with:\n          node-version: 18.x\n          cache: &#39;pnpm&#39;\n\n      - name: Install dependencies\n        run: pnpm i --frozen-lockfile\n\n      - name: Build\n        run: pnpm --filter=github-action-test-react build\n        env:\n          PUBLIC_PATH: /${{ github.event.repository.name }}/pr-${{ github.event.number }}/\n\n      - name: Move Pr Folder\n        run: |\n          mkdir -p pr-${{ github.event.number }}\n          mv page/* pr-${{ github.event.number }}\n          cp -r pr-${{ github.event.number }} page\n\n      - name: Deploy page\n        uses: JamesIves/github-pages-deploy-action@v4\n        with:\n          folder: page\n          clean: false\n\n      - name: Show Page Info\n        uses: marocchino/sticky-pull-request-comment@v2\n        with:\n          message: |\n            &gt; :rocket: Deployed page of ${{ github.event.pull_request.head.sha }}\n              https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr/${{ github.event.number }}</code>\n        </deckgo-highlight-code>\n<p>작업자의 pr단위로 페이지를 구성하려면 다음과 같은 설정이 필요하다.</p>\n<deckgo-highlight-code language=\"shell\"  >\n          <code slot=\"code\">- name: Build\n  run: pnpm --filter=github-action-test-react build\n  env:\n    PUBLIC_PATH: /${{ github.event.repository.name }}/pr-${{ github.event.number }}/</code>\n        </deckgo-highlight-code>\n<p>빌드 스크립트는 프로젝트 마다 다를 것이므로 여기서 봐야 할것은 PUBLIC_PATH의 환경변수 설정이다.</p>\n<p>깃헙 페이지 url 세그먼트는 커스텀 도메인을 사용하지 않는다면 아래와 같은 구조를 띄울 것이다.</p>\n<deckgo-highlight-code language=\"shell\"  >\n          <code slot=\"code\">https://{userId}.github.io/{repository-name}/**</code>\n        </deckgo-highlight-code>\n<p>레포지터리 이름의 마지막 path parameter에 작업자들의 pr단위를 github context에서 제공하는 변수로 생성한다.\n여기서 임시로 pr의 넘버링을 붙혔지만 다른 경로로 생성해도 된다.</p>\n<p>깃헙 페이지 배포 하기위해서는 해당 라이브러리를 사용 할 것이다.\nJamesIves/github-pages-deploy-action@v4</p>\n<p><a href=\"https://github.com/JamesIves/github-pages-deploy-action\">https://github.com/JamesIves/github-pages-deploy-action</a></p>\n<deckgo-highlight-code language=\"shell\"  >\n          <code slot=\"code\">- name: Move Pr Folder\n  run: |\n    mkdir -p pr-${{ github.event.number }}  // 배포될 폴더를 생성\n    mv page/* pr-${{ github.event.number }}   // 빌드 에셋이 들어 있는 page폴더를 이전 생성한 폴더로 이동\n    cp -r pr-${{ github.event.number }} page  // 복사\n\n- name: Deploy page\n  uses: JamesIves/github-pages-deploy-action@v4\n  with:\n    folder: page\n    clean: false</code>\n        </deckgo-highlight-code>\n<p>빌드된 에셋이 들어있는 폴더는 page로 설정 배포시 브랜치의 파일들을 보존하기 위해 clean을 비활성화한다.\n이렇게 된다면 깃헙페이지 배포 브랜치에 폴더 구조 설정은 다 끝났다.</p>\n<h2>SPA 설정</h2>\n<p>이제 빌드타임에 호출할 에셋들의 prefix 경로와 런타임 때 경로도 설정해야 한다.\n그렇지 않다면 깃헙 페이지는 리소스를 찾지 못해 404를 반환한다.</p>\n<p>여기서 base에 변수를 설정했으면 vite는 알아서 import.meta.env.BASE_URL 변수도 자동으로 변경해준다.</p>\n<deckgo-highlight-code language=\"javascript\"  >\n          <code slot=\"code\">// vite.config.js\nimport { defineConfig, loadEnv } from &#39;vite&#39;;\nimport react from &#39;@vitejs/plugin-react&#39;;\nimport path from &#39;path&#39;;\n\nexport default ({ mode }) =&gt; {\n  process.env = { ...process.env, ...loadEnv(mode, process.cwd()) };\n\n  return defineConfig({\n    plugins: [react()],\n\n    base: process.env.PUBLIC_PATH, // base 속성에는 앞서 ci/cd에서 설정한 환경 변수의 경로를 넣어준다.\n\n    build: {\n      outDir: path.resolve(__dirname, &#39;../../page&#39;),\n    },\n  });\n};</code>\n        </deckgo-highlight-code>\n<p>이제 이를 실제로 확인하기 위해서는 런타임때 라우터 경로를 해당 페이지 구조에 맞게 변경해줘야 한다.\nreact-router-dom 의 createBrowserRouter api를 사용해서 라우터를 생성했다.</p>\n<deckgo-highlight-code language=\"javascript\"  >\n          <code slot=\"code\">const router = createBrowserRouter([\n  {\n    path: import.meta.env.BASE_URL,\n    element: &lt;Root /&gt;,\n    children: [\n      {\n        path: &#39;&#39;,\n        element: &lt;Home /&gt;,\n      },\n      {\n        path: &#39;about&#39;,\n        element: &lt;About /&gt;,\n      },\n      {\n        path: &#39;sample&#39;,\n        element: &lt;Sample /&gt;,\n      },\n    ],\n  },\n]);</code>\n        </deckgo-highlight-code>\n<p>서비스가 단일페이지가 아닐경우 링크를 클릭 시 링크의 주소도 prefix를 설정해줘야 하는데. 아래와 같이 커스텀 링크를 만들어서 해결했다.</p>\n<deckgo-highlight-code language=\"javascript\"  >\n          <code slot=\"code\">import { Link } from &#39;react-router-dom&#39;;\n\nexport default function PrefixLink({\n  prefix = import.meta.env.BASE_URL || &#39;&#39;,\n  to,\n  children,\n}) {\n  return &lt;Link to={prefix + to}&gt;{children}&lt;/Link&gt;;\n}</code>\n        </deckgo-highlight-code>\n<p>위 예제는 간략하게 작성된 배포 스크립트이다 실제 실무에서는 서버의 api를 받아 호출할 수 없으므로 msw로 브라우저 api를 모킹하여\n배포하여야 한다.</p>","frontmatter":{"title":"qa 과정에서 깃헙페이지에 멀티 페이지 배포 워크 플로우 작성해보기","date":"2024-11-20","description":"with react"}},"previous":{"fields":{"slug":"/zustands는 어떻게 root provider 없이 상태관리를 할 수 있을까(1)/"},"frontmatter":{"title":"zustands는 어떻게 root provider 없이 상태관리를 할 수 있을까(1)"}},"next":null},"pageContext":{"id":"ae22ba41-45bb-5046-b973-f0cd5baaf80c","previousPostId":"fcc608fb-7c94-5a4a-bed1-edf260ca39fa","nextPostId":null}},"staticQueryHashes":["2841359383"],"slicesMap":{}}